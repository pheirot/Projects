<!DOCTYPE HTML>
<html>

<head>
    <title>Игра 2048</title>
    <meta charset="utf-8">
</head>

<body>

<canvas id='example'>Обновите браузер</canvas>

<script>
var example = document.getElementById("example");
ctx = example.getContext('2d');
// Размер одной ячейки
cellSize = 60;
//Набранные очки
var score = 0;
//Статус игры
var gameStatus=1;
// Массив карты поля
map = [
    [0, 0, 0, 0],
    [0, 0, 0, 0],
    [0, 0, 0, 0],
    [0, 0, 0, 0]
];
example.width = 6 * cellSize;
example.height = 6 * cellSize;
ctx.fillStyle = 'grey';
ctx.fillRect(0, 0, example.width, example.height);

//рисуем ячейку
function DrawCell(x, y){
    // Отрисовка внешней части ячейки
    ctx.fillStyle = 'green';
    ctx.fillRect(cellSize+x*cellSize, cellSize+y*cellSize, cellSize, cellSize);
    ctx.strokeStyle = 'black';
    ctx.strokeRect(cellSize+x*cellSize, cellSize+y*cellSize, cellSize, cellSize);
    // Отрисовка внутренней части
    ctx.fillStyle = 'orange';
    ctx.fillRect(cellSize+x*cellSize+cellSize*0.1, cellSize+y*cellSize+cellSize*0.1, cellSize*0.8, cellSize*0.8);
    ctx.fillStyle = 'blue';
    ctx.font = "20px sans-serif";
    if (map[y][x] != 0){
        ctx.fillText(map[y][x], cellSize*1.4+x*cellSize, cellSize*1.6+y*cellSize);
    }
}

//рисуем поле
function drawField(){
    ctx.fillStyle = 'grey';
    ctx.fillRect(0, cellSize, 6*cellSize, 4*cellSize);
    for (var i=0;i<=3;i++){
        for (var j=0;j<=3;j++){
        DrawCell(i,j);
        }
    }
}

//инструкция
function drawManual(){
    ctx.fillStyle = 'black';
    ctx.font = "20px sans-serif";
    ctx.fillText("Управление стрелками", 10, 5.5*cellSize);
    ctx.fillText("Пробел - пропуск хода", 10, 5.9*cellSize);
}

//Выводим кол-во очков
function drawScore(){
    ctx.fillStyle = 'grey';
    ctx.fillRect(0, 0, 6*cellSize, 0.9*cellSize);
    ctx.fillStyle = 'black';
    ctx.font = "40px sans-serif";
    ctx.fillText("Счёт: " + score, 10, 40);
}


//это для отладки...
function hideButtonCode(){
    ctx.fillStyle = 'grey';
    ctx.fillRect(0, 5.1*cellSize, 6*cellSize, cellSize);
}
function drawButtonCode(code){
    ctx.fillStyle = 'black';
    ctx.font = "40px sans-serif";
    ctx.fillText(code, 10, 5.6*cellSize);
}

//запуск новой игры
function startNewGame(code){
    if (code == 32 && gameStatus==0){
        gameStatus = 1;
        score = 0;
        map = [
        [0, 0, 0, 0],
        [0, 0, 0, 0],
        [0, 0, 0, 0],
        [0, 0, 0, 0]
        ];
	genNewCells();
    drawField();
	drawManual();
    } 
}

//проверка на геймовер
function checkGameOver(code){
    var total = 0;
    for (var i=0; i<4; i++)
    for (var j=0; j<4; j++){
        if (map[i][j] > 0) { total = total + 1}
    }
    if (total == 16) { 
        ctx.fillStyle = 'grey';
        ctx.fillRect(0, 0, 6*cellSize, 6*cellSize);
        drawScore();
        // Заливаем градиентом
        
        var gradient=ctx.createLinearGradient(0,0,6*cellSize,0);
        gradient.addColorStop("0","magenta");
        gradient.addColorStop("0.5","blue");
        gradient.addColorStop("1.0","red");
        ctx.fillStyle=gradient;
        ctx.font = "38px sans-serif";
        ctx.fillText('Game Over', cellSize, 3*cellSize);
        ctx.font = "20px sans-serif";
        ctx.fillText('Нажми пробел для новой игры', 0.5*cellSize, 4*cellSize);
        gameStatus = 0;
        ctx.fillStyle = 'black';
    }
}

//генерируем новую ячейку с цифрой 2
function genNewCells(){
    x = Math.floor(Math.random() * 4);
    y = Math.floor(Math.random() * 4);
    if (map[x][y] == 0){
         map[x][y] = 2;
    } else {
        genNewCells()
    };
}

//сдвигаем все ячейки влево/вправо/вниз/вверх
function shiftAll(code){
    switch (code){
        //Right
        case 39:
        for (var p=0;p<=3;p++){
            for (var i=0; i<4; i++){
                for (var j=0; j<3; j++){
                    if (map[i][j+1] == 0 && map[i][j] != 0) {
                        map[i][j+1] = map[i][j];
                        map[i][j]=0;
                        //ctx.fillText('i_='+i+'j_='+j, cellSize*3, 5.6*cellSize);               
                    }
                }
            }
        }
        break;
        //Left
        case 37:
        for (var p=0;p<=3;p++){
            for (var i=0; i <= 3; i++){
                for (var j=2; j >= 0; j--){
                    if (map[i][j] == 0 && map[i][j+1] != 0) {
                        map[i][j] = map[i][j+1];
                        map[i][j+1]=0;
                       // ctx.fillText('i_='+i+'j_='+j, cellSize*3, 5.6*cellSize);               
                    }
                }
            }
        }
        break;
        //Up
        case 38:
        for (var p=0;p<=3;p++){
            for (var j=0; j <= 3; j++){
                for (var i=2; i >= 0; i--){
                    if (map[i][j] == 0 && map[i+1][j] != 0) {
                        map[i][j] = map[i+1][j];
                        map[i+1][j]=0;
                        //ctx.fillText('i_='+i+'j_='+j, cellSize*3, 5.6*cellSize);               
                    }
                }
            }
        }
        break;
        //Down
        case 40:
        for (var p=0;p<=3;p++){
            for (var j=0; j <= 3; j++){
                for (var i=0; i <= 2; i++){
                    if (map[i+1][j] == 0 && map[i][j] != 0) {
                        map[i+1][j] = map[i][j];
                        map[i][j]=0;
                        //ctx.fillText('i_='+i+'j_='+j, cellSize*3, 5.6*cellSize);               
                    }
                }
            }
        }
        break;
    }
}

//складываем одинаковые ячейки
function pressButtonDouble(code){
    switch (code) {
        //RightArrow
        case 39:
            for (var i=0; i<4; i++){
                for (var j=0; j<3; j++){
                    if (map[i][j] == map[i][j+1] && map[i][j+1] != 0) {
                        map[i][j+1]=2*map[i][j];
                        map[i][j]=0;
                        //ctx.fillText('i='+i+'j='+j, cellSize*3, 5.6*cellSize);
                        score = score + map[i][j+1];        
                    }                  
                }
            }
        break;
        //LeftArrow
        case 37:
            for (var i=0; i<4; i++){
                for (var j=3; j>=0; j--){
                    if (map[i][j] == map[i][j+1] && map[i][j] != 0) {
                        map[i][j]=2*map[i][j+1];
                        map[i][j+1]=0;
                        //ctx.fillText('i='+i+'j='+j, cellSize*3, 5.6*cellSize);
                        score = score + map[i][j]; 
                        
                    }
                }
            }
        break;
         //DownArrow
         case 40:
            for (var i=0; i<3; i++)
            for (var j=0; j<4; j++){
            if (map[i][j] == map[i+1][j] && map[i+1][j] != 0) {
                map[i+1][j]=2*map[i][j];
                map[i][j]=0;
                //ctx.fillText('i='+i+'j='+j, cellSize*3, 5.6*cellSize);
                score = score + map[i+1][j]; 
            }
        }
        break;
         //UpArrow
         case 38:
            for (var i=0; i<3; i++)
            for (var j=0; j<4; j++){
            if (map[i][j] == map[i+1][j] && map[i][j] != 0) {
                map[i][j]=2*map[i+1][j];
                map[i+1][j]=0;
                //ctx.fillText('i='+i+'j='+j, cellSize*3, 5.6*cellSize);
                score = score + map[i][j]; 
            }
        }
        break;
    }
}

//отслеживаем события нажатия кнопок
window.addEventListener('keyup',this.check,false);

//Рисуем поле и счёт
genNewCells();
drawField();
drawScore();
drawManual();

//основной цикл
function check(e) {
    var code = e.keyCode;
    if (code >= 32 && code <= 40){
        if (gameStatus==1) {
            //hideButtonCode();
            //drawButtonCode(code);
			genNewCells();
            shiftAll(code);
            pressButtonDouble(code);
            drawField();
            drawScore(); 
            checkGameOver(code);
        }
        else {
        startNewGame(code);}
    }
}

</script>

</body>

</html>